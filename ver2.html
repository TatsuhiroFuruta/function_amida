<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>あみだくじ</title>
  <style>
    body { text-align: center; font-family: sans-serif; }
    .screen { display: none; }
    .active { display: block; }
    canvas { border: 1px solid #333; margin-top: 10px; }
    .name-input { margin: 2px; }
  </style>
</head>
<body>

  <!-- タイトル画面 -->
  <div id="titleScreen" class="screen active">
    <h1>あみだくじ</h1>
    <button onclick="showScreen('settingsScreen')">設定へ進む</button>
  </div>

  <!-- 設定画面 -->
  <div id="settingsScreen" class="screen">
    <h2>設定</h2>
    <label>人数: <input type="number" id="numPlayers" min="2" value="3"></label>
    <br><br>
    <div id="namesArea"></div>
    <br>
    <label>横線数: <input type="number" id="numLines" min="1" value="5"></label>
    <br><br>
    <button onclick="startAmida()">開始する</button>
  </div>

  <!-- あみだくじ画面 -->
  <div id="amidaScreen" class="screen">
    <h2>あみだくじ</h2>
    <div id="startButtons"></div>
    <canvas id="amidaCanvas" width="600" height="400"></canvas>
    <p id="result"></p>
    <button id="endButton" onclick="backToTitle()" style="display:none;">終了する</button>
  </div>

<script>
  // 画面切り替え
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // 人数入力に応じて名前欄を生成
  const numPlayersInput = document.getElementById('numPlayers');
  const namesArea = document.getElementById('namesArea');
  numPlayersInput.addEventListener('input', updateNameInputs);

  function updateNameInputs() {
    namesArea.innerHTML = '';
    for (let i = 0; i < numPlayersInput.value; i++) {
      namesArea.innerHTML += `名前${i+1}: <input class="name-input" id="name${i}" value="参加者${i+1}"><br>`;
    }
  }
  updateNameInputs(); // 初期表示

  // あみだくじ開始
  let players = [];
  let horizontalLines = [];
  let spacing;
  let topY = 20, bottomY = 380;
  const canvas = document.getElementById('amidaCanvas');
  const ctx = canvas.getContext('2d');

  function startAmida() {
    const n = parseInt(numPlayersInput.value);
    players = [];
    for (let i = 0; i < n; i++) {
      players.push(document.getElementById(`name${i}`).value);
    }
    const numLines = parseInt(document.getElementById('numLines').value);

    // 横線をランダム生成
    horizontalLines = [];
    for (let i = 0; i < numLines; i++) {
      const y = Math.floor(Math.random() * (bottomY - 60)) + 40;
      const xIndex = Math.floor(Math.random() * (n - 1));
      horizontalLines.push({ y, from: xIndex, to: xIndex + 1 });
    }

    spacing = canvas.width / (n + 1);
    drawAmida(n);

    // スタートボタン生成
    const startButtonsDiv = document.getElementById('startButtons');
    startButtonsDiv.innerHTML = '';
    for (let i = 0; i < n; i++) {
      const btn = document.createElement('button');
      btn.textContent = `${players[i]}スタート`;
      btn.onclick = () => startGame(i, n);
      startButtonsDiv.appendChild(btn);
    }

    document.getElementById('result').textContent = '';
    document.getElementById('endButton').style.display = 'none';

    showScreen('amidaScreen');
  }

  // あみだくじ描画
  function drawAmida(n) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = "black";
    ctx.lineWidth = 2;

    // 縦線
    for (let i = 0; i < n; i++) {
      const x = spacing * (i + 1);
      ctx.beginPath();
      ctx.moveTo(x, topY);
      ctx.lineTo(x, bottomY);
      ctx.stroke();
    }

    // 横線
    horizontalLines.forEach(line => {
      const x1 = spacing * (line.from + 1);
      const x2 = spacing * (line.to + 1);
      ctx.beginPath();
      ctx.moveTo(x1, line.y);
      ctx.lineTo(x2, line.y);
      ctx.stroke();
    });
  }

  // スタートしてゴールまでたどる
  function startGame(startIndex, n) {
    let xIndex = startIndex;
    let y = topY;

    function step() {
      if (y >= bottomY) {
        // ゴール位置でプレイヤー決定
        const resultName = players[xIndex];
        document.getElementById('result').textContent =
          `${players[startIndex]} → ゴール: ${resultName}`;
        document.getElementById('endButton').style.display = 'inline-block';
        return;
      }

      // 横線チェック
      const line = horizontalLines.find(l =>
        Math.abs(l.y - y) < 2 && (l.from === xIndex || l.to === xIndex));
      if (line) {
        // xIndex = 0,1,2,...と離散整数になっている。（縦線の管理方法）
        // 徐々に遷移する操作を行う場合、根本的な設定を書き換える必要がある。
        if (line.from === xIndex) xIndex = line.to; else xIndex = line.from;
        // if (line.from === xIndex) {
        //   xIndex = 1;
        // } else {
        //   xIndex = line.from;
        // }
      }

      drawAmida(n);
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(spacing * (xIndex + 1), y, 5, 0, Math.PI * 2);
      ctx.fill();

      y += 1;
      requestAnimationFrame(step);
    }
    step();
  }

  function backToTitle() {
    showScreen('titleScreen');
  }
</script>
</body>
</html>
