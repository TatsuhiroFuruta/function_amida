<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>あみだくじ</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; padding: 0;}
  section { display: none; padding: 20px;}
  section.active { display: block;}
  input, button { font-size: 1rem; margin: 5px; padding: 8px 12px;}
  canvas { background: #f8f8f8; border: 1px solid #ccc; margin: 10px auto; display: block; max-width: 100%;}
  #start-buttons button { font-size: 1.2rem; margin: 5px; padding: 10px 14px;}
  #endButton { font-size: 1.2rem; margin-top: 20px; padding: 10px 20px;}
</style>
</head>
<body>

<section id="title" class="active">
  <h1>あみだくじ</h1>
  <button id="toSettings">スタート</button>
</section>

<section id="settings">
  <h2>設定</h2>
  <label>人数: <input type="number" id="numPlayers" min="2" value="3"></label><br>
  <label>横線の数: <input type="number" id="numLadders" min="1" value="5"></label><br>
  <div id="nameInputs"></div>
  <button id="startGame">開始する</button>
</section>

<section id="amida">
  <h2 id="currentPlayerTitle"></h2>
  <canvas id="amidaCanvas" width="400" height="500"></canvas>
  <div id="start-buttons"></div>
  <button id="endButton" style="display:none;">終了する</button>
</section>

<script>
let playerNames = [];
let numPlayers = 3;
let numLadders = 5;
let ladders = [];
let currentIndex = 0;
let results = [];
let choices = []; //各プレイヤーの選んだ列
let ctx, canvas;
let columnWidth;

document.getElementById('toSettings').onclick = () => {
  showSection('settings');
  updateNameInputs();
};
document.getElementById('numPlayers').oninput = updateNameInputs;

function updateNameInputs() {
  numPlayers = parseInt(document.getElementById('numPlayers').value);
  const div = document.getElementById('nameInputs');
  div.innerHTML = '';
  for (let i = 0; i < numPlayers; i++) {
    div.innerHTML += `<label>名前${i+1}: <input type="text" id="name${i}" value="名前${i+1}"></label><br>`;
  }
}

document.getElementById('startGame').onclick = () => {
  numPlayers = parseInt(document.getElementById('numPlayers').value);
  numLadders = parseInt(document.getElementById('numLadders').value);
  playerNames = [];
  for (let i = 0; i < numPlayers; i++) {
    playerNames.push(document.getElementById(`name${i}`).value || `名前${i+1}`);
  }
  currentIndex = 0;
  results = [];
  choices = [];
  showSection('amida');
  setupAmida();
};

document.getElementById('endButton').onclick = () => {
  showSection('title');
};

function showSection(id) {
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function setupAmida() {
  canvas = document.getElementById('amidaCanvas');
  ctx = canvas.getContext('2d');
  columnWidth = canvas.width / (numPlayers + 1);

  // 横線生成
  ladders = [];
  for (let i = 0; i < numLadders; i++) {
    const x = Math.floor(Math.random()*(numPlayers-1)) + 1; //列間
    const y = Math.random() * (canvas.height - 50) + 25;
    ladders.push({col:x, y:y});
  }

  drawAmida();
  showCurrentPlayer();
  setupStartButtons();
}

function drawAmida() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2;

  // 縦線
  for (let i=1; i<=numPlayers; i++) {
    ctx.beginPath();
    ctx.moveTo(columnWidth*i, 20);
    ctx.lineTo(columnWidth*i, canvas.height-20);
    ctx.stroke();
  }

  // 横線
  for (const l of ladders) {
    ctx.beginPath();
    ctx.moveTo(columnWidth*l.col, l.y);
    ctx.lineTo(columnWidth*(l.col+1), l.y);
    ctx.stroke();
  }

  // ゴール名
  for (const r of results) {
    ctx.fillStyle = 'blue';
    ctx.font = '14px sans-serif';
    ctx.fillText(r.player, columnWidth*(r.goal+1)-20, canvas.height-5);
  }
}

function showCurrentPlayer() {
  if(currentIndex < playerNames.length){
    document.getElementById('currentPlayerTitle').textContent =
      `現在のプレイヤー: ${playerNames[currentIndex]} さん 列を選んでください`;
  }
}

function setupStartButtons() {
  const startButtons = document.getElementById('start-buttons');
  startButtons.innerHTML = '';
  for (let i=0;i<numPlayers;i++) {
    const btn = document.createElement('button');
    btn.textContent = `列${i+1}`;
    btn.onclick = () => chooseColumn(i);
    startButtons.appendChild(btn);
  }
}

function chooseColumn(colIndex){
  choices[currentIndex] = colIndex; //選んだ列だけ記録
  currentIndex++;
  if(currentIndex<playerNames.length){
    showCurrentPlayer();
  }else{
    //全員選び終わり
    document.getElementById('start-buttons').innerHTML='';
    document.getElementById('currentPlayerTitle').textContent='全員の選択完了！順に結果を表示します';
    startSequentialAnimation(0);
  }
}

function startSequentialAnimation(i){
  if(i>=playerNames.length){
    document.getElementById('endButton').style.display='block';
    return;
  }
  animateAmida(choices[i], goal=>{
    results.push({player:playerNames[i],goal:goal});
    drawAmida();
    startSequentialAnimation(i+1); //次の人
  });
}

function animateAmida(col, callback) {
  let x = col;
  let y = 20;
  const step = 2; // 下り速度

  const interval = setInterval(()=>{
    // 横線チェック
    const nearLadder = ladders.find(l=>Math.abs(l.y - y)<2 && (l.col===x||l.col===x-1));
    if (nearLadder) {
      // 横移動
      if (nearLadder.col===x) x++;
      else if (nearLadder.col===x-1) x--;
    }
    y += step;
    drawAmida();
    ctx.fillStyle='red';
    ctx.beginPath();
    ctx.arc(columnWidth*(x+1), y, 5, 0, Math.PI*2);
    ctx.fill();

    if (y>canvas.height-20) {
      clearInterval(interval);
      callback(x);
    }
  },16);
}
</script>
</body>
</html>
