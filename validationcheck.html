<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>あみだくじ</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    margin: 0;
    background: #f7f7f7;
  }
  .screen { display: none; padding: 20px; }
  .active { display: block; }

  #labels {
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
  }
  .column-label {
    width: 60px;
    text-align: center;
    font-weight: bold;
    background: #ddd;
    margin: 0 5px;
    border-radius: 6px;
    padding: 4px;
    cursor: pointer;
  }

  #amida {
    position: relative;
    display: flex;
    justify-content: center;
    margin-top: 10px;
    height: 300px;
  }
  .line {
    position: relative;
    width: 60px;
    background: #000;
    margin: 0 5px;
  }
  .horizontal {
    position: absolute;
    height: 2px;
    background: #000;
  }

  .buttons {
    margin-top: 20px;
  }

  button {
    padding: 10px 20px;
    margin: 5px;
    font-size: 16px;
  }

  /* フラッシュメッセージ */
  #flash {
    color: red;
    margin: 10px 0;
    font-weight: bold;
  }
</style>
</head>
<body>

<div id="title" class="screen active">
  <h1>あみだくじ</h1>
  <button onclick="showScreen('settings')">スタート</button>
</div>

<div id="settings" class="screen">
  <h2>設定</h2>
  <label>人数 (2〜6人): 
    <input id="playerCount" type="number" min="2" max="6" value="3">
  </label><br><br>
  <label>横線の数: 
    <input id="hCount" type="number" min="1" max="20" value="5">
  </label><br><br>
  <div id="names"></div>
  <div id="flash"></div>
  <button onclick="startAmida()">開始する</button>
</div>

<div id="amidaScreen" class="screen">
  <h2>あみだくじ</h2>
  <div id="labels"></div>
  <div id="amida"></div>
  <div class="buttons">
    <button id="startBtn" onclick="startMove()" style="display:none;">スタート（順に動かす）</button>
    <button id="endBtn" onclick="showScreen('title')" style="display:none;">終了する</button>
  </div>
</div>

<script>
let players = [];
let currentPlayerIndex = 0;
let chosenColumns = [];
let playerCount = 3;
let hCount = 5;
let results = [];
let amidaData = [];

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='settings'){
    renderNameInputs();
    document.getElementById('flash').textContent = '';
  }
}

// 名前入力欄を生成
function renderNameInputs(){
  playerCount = parseInt(document.getElementById('playerCount').value);
  const namesDiv = document.getElementById('names');
  namesDiv.innerHTML = '';
  for(let i=0;i<playerCount;i++){
    namesDiv.innerHTML += `<div>名前${i+1}: <input type="text" id="name${i}" maxlength="6" placeholder="6文字以内"></div>`;
  }
}

// 入力検証
function validateSettings(){
  const flash = document.getElementById('flash');
  playerCount = parseInt(document.getElementById('playerCount').value);

  // 人数チェック
  if(playerCount < 2 || playerCount > 6){
    flash.textContent = '人数は2〜6人にしてください。';
    return false;
  }

  // 名前チェック
  for(let i=0;i<playerCount;i++){
    const name = document.getElementById('name'+i).value.trim();
    if(name === ''){
      flash.textContent = `名前${i+1}が空欄です。全員入力してください。`;
      return false;
    }
    if(name.length > 6){
      flash.textContent = `名前${i+1}が6文字を超えています。`;
      return false;
    }
  }

  flash.textContent = '';
  return true;
}

// あみだ開始
function startAmida(){
  if(!validateSettings()) return;

  playerCount = parseInt(document.getElementById('playerCount').value);
  hCount = parseInt(document.getElementById('hCount').value);
  players = [];
  for(let i=0;i<playerCount;i++){
    players.push(document.getElementById('name'+i).value.trim());
  }
  currentPlayerIndex=0;
  chosenColumns=[];
  results=[];
  buildAmida();
  showScreen('amidaScreen');
}

// あみだ描画
function buildAmida(){
  const labelsDiv=document.getElementById('labels');
  labelsDiv.innerHTML='';
  for(let i=0;i<playerCount;i++){
    const lbl=document.createElement('div');
    lbl.className='column-label';
    lbl.textContent=`列${i+1}`;
    lbl.dataset.index=i;
    lbl.onclick=()=>chooseColumn(i,lbl);
    labelsDiv.appendChild(lbl);
  }

  const amida=document.getElementById('amida');
  amida.innerHTML='';
  amidaData=[];
  for(let i=0;i<playerCount;i++){
    const line=document.createElement('div');
    line.className='line';
    amida.appendChild(line);
  }

  for(let y=0;y<hCount;y++){
    const pos=Math.floor(Math.random()*(playerCount-1));
    amidaData.push(pos);
  }

  const height=amida.clientHeight;
  for(let i=0;i<hCount;i++){
    const y=(height/(hCount+1))*(i+1);
    const x=amidaData[i];
    const line=amida.children[x];
    const horiz=document.createElement('div');
    horiz.className='horizontal';
    horiz.style.top=y+'px';
    horiz.style.left='100%';
    horiz.style.width='60px';
    line.appendChild(horiz);
  }

  document.getElementById('startBtn').style.display='none';
  document.getElementById('endBtn').style.display='none';
}

// 列選択
function chooseColumn(idx,lbl){
  if(chosenColumns.includes(idx)) return;
  if(currentPlayerIndex>=players.length) return;
  lbl.textContent=players[currentPlayerIndex];
  chosenColumns.push(idx);
  currentPlayerIndex++;
  if(currentPlayerIndex===players.length){
    document.getElementById('startBtn').style.display='inline-block';
  }
}

// 順に動かす
async function startMove(){
  document.getElementById('startBtn').style.display='none';
  for(let i=0;i<players.length;i++){
    await animatePath(chosenColumns[i],players[i]);
  }
  document.getElementById('endBtn').style.display='inline-block';
}

// 動きアニメーション
function animatePath(startIndex,name){
  return new Promise((resolve)=>{
    let y=0;
    let x=startIndex;
    const height=document.getElementById('amida').clientHeight;
    const interval=setInterval(()=>{
      y+=5;
      amidaData.forEach((pos,index)=>{
        const yCheck=(height/(hCount+1))*(index+1);
        if(Math.abs(y-yCheck)<3){
          if(x===pos) x++;
          else if(x===pos+1) x--;
        }
      });
      if(y>=height){
        clearInterval(interval);
        alert(`${name} は 列${x+1} に到達しました`);
        resolve();
      }
    },30);
  });
}
</script>
</body>
</html>
