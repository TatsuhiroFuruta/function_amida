<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>あみだくじ</title>
  <style>
    body { text-align: center; font-family: sans-serif; }
    .screen { display: none; }
    .active { display: block; }
    canvas { border: 1px solid #333; margin-top: 10px; }
    .name-input { margin: 2px; }
  </style>
</head>
<body>

  <!-- タイトル画面 -->
  <div id="titleScreen" class="screen active">
    <h1>あみだくじ</h1>
    <button onclick="showScreen('settingsScreen')">設定へ進む</button>
  </div>

  <!-- 設定画面 -->
  <div id="settingsScreen" class="screen">
    <h2>設定</h2>
    <label>人数: <input type="number" id="numPlayers" min="2" value="3"></label>
    <br><br>
    <div id="namesArea"></div>
    <br>
    <label>横線数: <input type="number" id="numLines" min="1" value="5"></label>
    <br><br>
    <button onclick="startAmida()">開始する</button>
  </div>

  <!-- あみだくじ画面 -->
  <div id="amidaScreen" class="screen">
    <h2>あみだくじ</h2>
    <div id="startButtons"></div>
    <canvas id="amidaCanvas" width="600" height="400"></canvas>
    <p id="result"></p>
    <button id="endButton" onclick="backToTitle()" style="display:none;">終了する</button>
  </div>

<script>
  // 画面切り替え
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // 人数入力に応じて名前欄を生成
  const numPlayersInput = document.getElementById('numPlayers');
  const namesArea = document.getElementById('namesArea');
  numPlayersInput.addEventListener('input', updateNameInputs);

  function updateNameInputs() {
    namesArea.innerHTML = '';
    for (let i = 0; i < numPlayersInput.value; i++) {
      namesArea.innerHTML += `名前${i+1}: <input class="name-input" id="name${i}" value="参加者${i+1}"><br>`;
    }
  }
  updateNameInputs(); // 初期表示

  // あみだくじ関連変数
  let players = [];
  let horizontalLines = [];
  let spacing;
  let topY = 20, bottomY = 360;
  const canvas = document.getElementById('amidaCanvas');
  const ctx = canvas.getContext('2d');
  let resultsMap = {};   // 誰がどこに着いたか記録
  let finishedCount = 0; // ゴールした人数
  let totalPlayers = 0;

  function startAmida() {
    const n = parseInt(numPlayersInput.value);
    players = [];
    for (let i = 0; i < n; i++) {
      players.push(document.getElementById(`name${i}`).value);
    }
    totalPlayers = n;
    finishedCount = 0;
    resultsMap = {};

    const numLines = parseInt(document.getElementById('numLines').value);
    // 横線をランダム生成
    horizontalLines = [];
    for (let i = 0; i < numLines; i++) {
      const y = Math.floor(Math.random() * (bottomY - 60)) + 40;
      const xIndex = Math.floor(Math.random() * (n - 1));
      horizontalLines.push({ y, from: xIndex, to: xIndex + 1 });
    }

    spacing = canvas.width / (n + 1);
    drawAmida(n, true);

    // スタートボタン生成
    const startButtonsDiv = document.getElementById('startButtons');
    startButtonsDiv.innerHTML = '';
    for (let i = 0; i < n; i++) {
      const btn = document.createElement('button');
      btn.textContent = `${players[i]}スタート`;
      btn.onclick = () => startGame(i, n);
      startButtonsDiv.appendChild(btn);
    }

    document.getElementById('result').textContent = '';
    document.getElementById('endButton').style.display = 'none';

    showScreen('amidaScreen');
  }

  // あみだくじ描画
  function drawAmida(n, clearNames = false) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = "black";
    ctx.lineWidth = 2;

    // 縦線
    for (let i = 0; i < n; i++) {
      const x = spacing * (i + 1);
      ctx.beginPath();
      ctx.moveTo(x, topY);
      ctx.lineTo(x, bottomY);
      ctx.stroke();
    }

    // 横線
    horizontalLines.forEach(line => {
      const x1 = spacing * (line.from + 1);
      const x2 = spacing * (line.to + 1);
      ctx.beginPath();
      ctx.moveTo(x1, line.y);
      ctx.lineTo(x2, line.y);
      ctx.stroke();
    });

    // ゴールラベル
    ctx.font = "12px sans-serif";
    for (let i = 0; i < n; i++) {
      ctx.fillStyle = "gray";
      ctx.fillText(`ゴール${i+1}`, spacing * (i + 1) - 15, bottomY + 20);
    }

    // 既にゴールした人の名前
    for (const name in resultsMap) {
      const xi = resultsMap[name];
      ctx.fillStyle = "blue";
      ctx.fillText(name, spacing * (xi + 1) - 15, bottomY + 35);
    }
  }

  // スタートしてゴールまでたどる（横線ゆっくり移動）
  function startGame(startIndex, n) {
    let xIndex = startIndex;
    let x = spacing * (xIndex + 1);
    let y = topY;
    let state = "down"; // down or horizontal
    let targetX = x;

    function step() {
      if (y >= bottomY) {
        // ゴール記録
        resultsMap[players[startIndex]] = xIndex;
        finishedCount++;
        drawAmida(n); // ゴール後も描画更新
        if (finishedCount === totalPlayers) {
          document.getElementById('endButton').style.display = 'inline-block';
        }
        return;
      }

      if (state === "down") {
        // 横線に当たったか
        const line = horizontalLines.find(l =>
          Math.abs(l.y - y) < 2 && (l.from === xIndex || l.to === xIndex));
        if (line) {
          // 横移動に切り替え
          if (line.from === xIndex) {
            xIndex = line.to;
            targetX = spacing * (xIndex + 1);
          } else {
            xIndex = line.from;
            targetX = spacing * (xIndex + 1);
          }
          state = "horizontal";
        } else {
          y += 2; // 縦移動
        }
      } else if (state === "horizontal") {
        // 横線を徐々に移動
        let dx = targetX - x;
        if (Math.abs(dx) < 1) {
          state = "down"; // 横移動終わり
          y += 2;
        } else {
          x += dx / 5;
        }
      }

      drawAmida(n);
      // 現在位置描画
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fill();

      requestAnimationFrame(step);
    }
    step();
  }

  function backToTitle() {
    showScreen('titleScreen');
  }
</script>
</body>
</html>
