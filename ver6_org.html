<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>あみだくじ</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    margin: 0;
    background: #f7f7f7;
  }
  .screen { display: none; padding: 20px; }
  .active { display: block; }

  #labels {
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
  }
  .column-label {
    width: 60px;
    text-align: center;
    font-weight: bold;
    background: #ddd;
    margin: 0 5px;
    border-radius: 6px;
    padding: 4px;
    cursor: pointer;
  }

  #amida {
    position: relative;
    display: flex;
    justify-content: center;
    margin-top: 10px;
    height: 300px;
  }
  .line {
    position: relative;
    width: 60px;
    background: #000;
    margin: 0 5px;
  }
  .horizontal {
    position: absolute;
    height: 2px;
    background: #000;
  }

  .buttons {
    margin-top: 20px;
  }

  button {
    padding: 10px 20px;
    margin: 5px;
    font-size: 16px;
  }
</style>
</head>
<body>

<div id="title" class="screen active">
  <h1>あみだくじ</h1>
  <button onclick="showScreen('settings')">スタート</button>
</div>

<div id="settings" class="screen">
  <h2>設定</h2>
  <label>人数: <input id="playerCount" type="number" min="2" max="8" value="3"></label><br><br>
  <label>横線の数: <input id="hCount" type="number" min="1" max="20" value="5"></label><br><br>
  <div id="names"></div>
  <button onclick="startAmida()">開始する</button>
</div>

<div id="amidaScreen" class="screen">
  <h2>あみだくじ</h2>
  <div id="labels"></div>
  <div id="amida"></div>
  <div class="buttons">
    <button id="startBtn" onclick="startMove()" style="display:none;">スタート（順に動かす）</button>
    <button id="endBtn" onclick="showScreen('title')" style="display:none;">終了する</button>
  </div>
</div>

<script>
let players = [];
let currentPlayerIndex = 0;
let chosenColumns = [];
let playerCount = 3;
let hCount = 5;
let results = [];
let amidaData = [];

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='settings'){
    renderNameInputs();
  }
}

// 設定画面に名前入力を出す
function renderNameInputs(){
  playerCount = parseInt(document.getElementById('playerCount').value);
  const namesDiv = document.getElementById('names');
  namesDiv.innerHTML = '';
  for(let i=0;i<playerCount;i++){
    namesDiv.innerHTML += `<div>名前${i+1}: <input type="text" id="name${i}" value="名前${i+1}"></div>`;
  }
}

// 開始
function startAmida(){
  playerCount = parseInt(document.getElementById('playerCount').value);
  hCount = parseInt(document.getElementById('hCount').value);
  players = [];
  for(let i=0;i<playerCount;i++){
    players.push(document.getElementById('name'+i).value || `名前${i+1}`);
  }
  currentPlayerIndex=0;
  chosenColumns=[];
  results=[];
  buildAmida();
  showScreen('amidaScreen');
}

// あみだくじ構築
function buildAmida(){
  // ラベル
  const labelsDiv=document.getElementById('labels');
  labelsDiv.innerHTML='';
  for(let i=0;i<playerCount;i++){
    const lbl=document.createElement('div');
    lbl.className='column-label';
    lbl.textContent=`列${i+1}`;
    lbl.dataset.index=i;
    lbl.onclick=()=>chooseColumn(i,lbl);
    labelsDiv.appendChild(lbl);
  }
  // 縦線
  const amida=document.getElementById('amida');
  amida.innerHTML='';
  amidaData=[];
  for(let i=0;i<playerCount;i++){
    const line=document.createElement('div');
    line.className='line';
    amida.appendChild(line);
  }
  // 横線データ作成
  for(let y=0;y<hCount;y++){
    const pos=Math.floor(Math.random()*(playerCount-1));
    amidaData.push(pos);
  }
  // 横線描画
  const height=amida.clientHeight;
  for(let i=0;i<hCount;i++){
    const y=(height/(hCount+1))*(i+1);
    const x=amidaData[i];
    const line=amida.children[x];
    const horiz=document.createElement('div');
    horiz.className='horizontal';
    horiz.style.top=y+'px';
    horiz.style.left='100%';
    horiz.style.width='60px';
    line.appendChild(horiz);
  }
  document.getElementById('startBtn').style.display='none';
  document.getElementById('endBtn').style.display='none';
}

// 列選択
function chooseColumn(idx,lbl){
  if(chosenColumns.includes(idx)) return;
  if(currentPlayerIndex>=players.length) return;
  lbl.textContent=players[currentPlayerIndex];
  chosenColumns.push(idx);
  currentPlayerIndex++;
  if(currentPlayerIndex===players.length){
    document.getElementById('startBtn').style.display='inline-block';
  }
}

// 順に動かす
async function startMove(){
  document.getElementById('startBtn').style.display='none';
  for(let i=0;i<players.length;i++){
    await animatePath(chosenColumns[i],players[i]);
  }
  document.getElementById('endBtn').style.display='inline-block';
}

// 動きアニメーション
function animatePath(startIndex,name){
  return new Promise((resolve)=>{
    let y=0;
    let x=startIndex;
    const height=document.getElementById('amida').clientHeight;
    const interval=setInterval(()=>{
      y+=5;
      // 横線との交差チェック
      amidaData.forEach((pos,index)=>{
        const yCheck=(height/(hCount+1))*(index+1);
        if(Math.abs(y-yCheck)<3){
          if(x===pos) x++;
          else if(x===pos+1) x--;
        }
      });
      if(y>=height){
        clearInterval(interval);
        // ゴール表示
        alert(`${name} は 列${x+1} に到達しました`);
        resolve();
      }
    },30);
  });
}
</script>
</body>
</html>
